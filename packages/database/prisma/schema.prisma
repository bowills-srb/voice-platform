generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ORGANIZATIONS & AUTH
// =====================================================

model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique

  stripeCustomerId String? @map("stripe_customer_id")
  planType         String  @default("free") @map("plan_type")

  concurrentCallLimit Int @default(10) @map("concurrent_call_limit")
  monthlyMinuteLimit  Int @default(1000) @map("monthly_minute_limit")

  settings Json @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users               User[]
  apiKeys             ApiKey[]
  assistants          Assistant[]
  tools               Tool[]
  knowledgeBases      KnowledgeBase[]
  squads              Squad[]
  phoneNumbers        PhoneNumber[]
  calls               Call[]
  campaigns           Campaign[]
  webhooks            Webhook[]
  providerCredentials ProviderCredential[]
  usageRecords        UsageRecord[]
  invoices            Invoice[]

  @@map("organizations")
}

model User {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  email        String  @unique
  passwordHash String? @map("password_hash")
  name         String?
  avatar       String?

  role String @default("member")

  googleId String? @map("google_id")
  githubId String? @map("github_id")

  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  apiKeys      ApiKey[]

  @@map("users")
}

model ApiKey {
  id     String  @id @default(uuid())
  orgId  String  @map("org_id")
  userId String? @map("user_id")

  name      String
  keyHash   String @map("key_hash")
  keyPrefix String @map("key_prefix")

  scopes Json @default("[\"*\"]")

  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("api_keys")
}

// =====================================================
// ASSISTANTS
// =====================================================

model Assistant {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  name String

  modelProvider    String @map("model_provider")
  modelName        String @map("model_name")
  modelTemperature Float  @default(0.7) @map("model_temperature")
  modelMaxTokens   Int    @default(150) @map("model_max_tokens")

  systemPrompt     String  @map("system_prompt")
  firstMessage     String? @map("first_message")
  firstMessageMode String  @default("assistant-speaks-first") @map("first_message_mode")

  voiceProvider String @map("voice_provider")
  voiceId       String @map("voice_id")
  voiceSettings Json   @default("{}") @map("voice_settings")

  transcriberProvider String @default("deepgram") @map("transcriber_provider")
  transcriberModel    String @default("nova-2") @map("transcriber_model")
  transcriberLanguage String @default("en") @map("transcriber_language")

  interruptionEnabled    Boolean @default(true) @map("interruption_enabled")
  fillerWordsEnabled     Boolean @default(false) @map("filler_words_enabled")
  silenceTimeoutMs       Int     @default(2000) @map("silence_timeout_ms")
  maxCallDurationSeconds Int     @default(1800) @map("max_call_duration_seconds")
  endpointingSensitivity Float   @default(0.5) @map("endpointing_sensitivity")
  endCallEnabled         Boolean @default(true) @map("end_call_enabled")

  metadata Json    @default("{}")
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tools        AssistantTool[]
  phoneNumbers PhoneNumber[]   @relation("InboundAssistant")
  calls        Call[]
  squads       SquadMember[]
  squadEntry   Squad[]         @relation("EntryAssistant")
  campaigns    Campaign[]

  @@map("assistants")
}

// =====================================================
// TOOLS
// =====================================================

model Tool {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  name        String
  type        String
  description String?

  functionDefinition   Json?   @map("function_definition")
  serverUrl            String? @map("server_url")
  transferDestinations Json?   @map("transfer_destinations")
  transferMode         String? @default("blind") @map("transfer_mode")
  knowledgeBaseId      String? @map("knowledge_base_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization  Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  knowledgeBase KnowledgeBase?  @relation(fields: [knowledgeBaseId], references: [id])
  assistants    AssistantTool[]

  @@map("tools")
}

model AssistantTool {
  assistantId String @map("assistant_id")
  toolId      String @map("tool_id")

  assistant Assistant @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  tool      Tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@id([assistantId, toolId])
  @@map("assistant_tools")
}

// =====================================================
// KNOWLEDGE BASES
// =====================================================

model KnowledgeBase {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  name        String
  description String?

  embeddingProvider String @default("openai") @map("embedding_provider")
  embeddingModel    String @default("text-embedding-3-small") @map("embedding_model")

  chunkSize    Int @default(500) @map("chunk_size")
  chunkOverlap Int @default(50) @map("chunk_overlap")

  documentCount Int @default(0) @map("document_count")
  totalChunks   Int @default(0) @map("total_chunks")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  documents    KnowledgeDocument[]
  chunks       KnowledgeChunk[]
  tools        Tool[]

  @@map("knowledge_bases")
}

model KnowledgeDocument {
  id              String @id @default(uuid())
  knowledgeBaseId String @map("knowledge_base_id")

  filename      String
  fileType      String? @map("file_type")
  fileSizeBytes Int?    @map("file_size_bytes")
  fileUrl       String? @map("file_url")

  status       String  @default("processing")
  errorMessage String? @map("error_message")
  chunkCount   Int     @default(0) @map("chunk_count")

  createdAt DateTime @default(now()) @map("created_at")

  knowledgeBase KnowledgeBase    @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  chunks        KnowledgeChunk[]

  @@map("knowledge_documents")
}

model KnowledgeChunk {
  id              String @id @default(uuid())
  documentId      String @map("document_id")
  knowledgeBaseId String @map("knowledge_base_id")

  content   String
  embedding Bytes?

  chunkIndex Int?  @map("chunk_index")
  metadata   Json  @default("{}")

  createdAt DateTime @default(now()) @map("created_at")

  document      KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  knowledgeBase KnowledgeBase     @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  @@map("knowledge_chunks")
}

// =====================================================
// SQUADS
// =====================================================

model Squad {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  name             String
  description      String?
  entryAssistantId String? @map("entry_assistant_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization   Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  entryAssistant Assistant?    @relation("EntryAssistant", fields: [entryAssistantId], references: [id])
  members        SquadMember[]
  phoneNumbers   PhoneNumber[] @relation("InboundSquad")
  calls          Call[]

  @@map("squads")
}

model SquadMember {
  id          String @id @default(uuid())
  squadId     String @map("squad_id")
  assistantId String @map("assistant_id")

  transferConditions Json? @map("transfer_conditions")
  position           Int   @default(0)

  squad     Squad     @relation(fields: [squadId], references: [id], onDelete: Cascade)
  assistant Assistant @relation(fields: [assistantId], references: [id], onDelete: Cascade)

  @@map("squad_members")
}

// =====================================================
// PHONE NUMBERS
// =====================================================

model PhoneNumber {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  phoneNumber     String @map("phone_number")
  phoneNumberE164 String @map("phone_number_e164")

  provider   String
  providerId String? @map("provider_id")

  countryCode  String? @map("country_code")
  capabilities Json    @default("[\"voice\"]")

  inboundAssistantId String? @map("inbound_assistant_id")
  inboundSquadId     String? @map("inbound_squad_id")
  fallbackNumber     String? @map("fallback_number")

  monthlyCostCents Int? @map("monthly_cost_cents")

  status String @default("active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  inboundAssistant Assistant?   @relation("InboundAssistant", fields: [inboundAssistantId], references: [id])
  inboundSquad     Squad?       @relation("InboundSquad", fields: [inboundSquadId], references: [id])
  calls            Call[]
  campaigns        Campaign[]

  @@map("phone_numbers")
}

// =====================================================
// CALLS
// =====================================================

model Call {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  type String

  phoneNumberId String? @map("phone_number_id")
  fromNumber    String? @map("from_number")
  toNumber      String? @map("to_number")

  assistantId String? @map("assistant_id")
  squadId     String? @map("squad_id")

  webCallUrl String? @map("web_call_url")

  status      String
  endedReason String? @map("ended_reason")

  startedAt  DateTime? @map("started_at")
  answeredAt DateTime? @map("answered_at")
  endedAt    DateTime? @map("ended_at")

  durationSeconds Int? @map("duration_seconds")

  costCents     Int  @default(0) @map("cost_cents")
  costBreakdown Json @default("{}") @map("cost_breakdown")

  recordingUrl       String? @map("recording_url")
  stereoRecordingUrl String? @map("stereo_recording_url")

  analysis Json @default("{}")
  metadata Json @default("{}")

  campaignId String? @map("campaign_id")

  createdAt DateTime @default(now()) @map("created_at")

  organization     Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  phoneNumber      PhoneNumber?      @relation(fields: [phoneNumberId], references: [id])
  assistant        Assistant?        @relation(fields: [assistantId], references: [id])
  squad            Squad?            @relation(fields: [squadId], references: [id])
  campaign         Campaign?         @relation(fields: [campaignId], references: [id])
  messages         CallMessage[]
  events           CallEvent[]
  usageRecords     UsageRecord[]
  campaignContacts CampaignContact[]

  @@index([orgId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("calls")
}

model CallMessage {
  id     String @id @default(uuid())
  callId String @map("call_id")

  role    String
  content String

  toolName      String? @map("tool_name")
  toolArguments Json?   @map("tool_arguments")
  toolResult    Json?   @map("tool_result")

  timestampMs Int  @map("timestamp_ms")
  durationMs  Int? @map("duration_ms")

  sttLatencyMs Int? @map("stt_latency_ms")
  llmLatencyMs Int? @map("llm_latency_ms")
  ttsLatencyMs Int? @map("tts_latency_ms")

  createdAt DateTime @default(now()) @map("created_at")

  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@map("call_messages")
}

model CallEvent {
  id     String @id @default(uuid())
  callId String @map("call_id")

  eventType   String @map("event_type")
  eventData   Json   @default("{}") @map("event_data")
  timestampMs Int    @map("timestamp_ms")

  createdAt DateTime @default(now()) @map("created_at")

  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@map("call_events")
}

// =====================================================
// CAMPAIGNS
// =====================================================

model Campaign {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  name String

  assistantId   String? @map("assistant_id")
  phoneNumberId String? @map("phone_number_id")

  status String @default("draft")

  scheduledAt DateTime? @map("scheduled_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  totalContacts  Int @default(0) @map("total_contacts")
  callsCompleted Int @default(0) @map("calls_completed")
  callsAnswered  Int @default(0) @map("calls_answered")
  callsVoicemail Int @default(0) @map("calls_voicemail")
  callsFailed    Int @default(0) @map("calls_failed")

  maxConcurrentCalls Int @default(5) @map("max_concurrent_calls")
  retryAttempts      Int @default(2) @map("retry_attempts")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assistant    Assistant?        @relation(fields: [assistantId], references: [id])
  phoneNumber  PhoneNumber?      @relation(fields: [phoneNumberId], references: [id])
  contacts     CampaignContact[]
  calls        Call[]

  @@map("campaigns")
}

model CampaignContact {
  id         String @id @default(uuid())
  campaignId String @map("campaign_id")

  phoneNumber String @map("phone_number")
  variables   Json   @default("{}")

  status String @default("pending")

  callId  String? @map("call_id")
  outcome String?

  attempts      Int       @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at")

  createdAt DateTime @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  call     Call?    @relation(fields: [callId], references: [id])

  @@index([campaignId])
  @@index([status])
  @@map("campaign_contacts")
}

// =====================================================
// WEBHOOKS
// =====================================================

model Webhook {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  url    String
  events Json   @default("[\"*\"]")
  secret String?

  isActive Boolean @default(true) @map("is_active")

  lastTriggeredAt DateTime? @map("last_triggered_at")
  failureCount    Int       @default(0) @map("failure_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  logs         WebhookLog[]

  @@map("webhooks")
}

model WebhookLog {
  id        String @id @default(uuid())
  webhookId String @map("webhook_id")

  eventType String @map("event_type")
  payload   Json

  responseStatus Int?    @map("response_status")
  responseBody   String? @map("response_body")
  responseTimeMs Int?    @map("response_time_ms")

  success      Boolean
  errorMessage String? @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_logs")
}

// =====================================================
// PROVIDER CREDENTIALS
// =====================================================

model ProviderCredential {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  provider             String
  credentialsEncrypted Bytes  @map("credentials_encrypted")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, provider])
  @@map("provider_credentials")
}

// =====================================================
// BILLING
// =====================================================

model UsageRecord {
  id     String  @id @default(uuid())
  orgId  String  @map("org_id")
  callId String? @map("call_id")

  usageType String  @map("usage_type")
  provider  String?

  durationSeconds Float? @map("duration_seconds")
  tokensInput     Int?   @map("tokens_input")
  tokensOutput    Int?   @map("tokens_output")
  characters      Int?

  costCents Int @map("cost_cents")

  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  createdAt DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  call         Call?        @relation(fields: [callId], references: [id])

  @@index([orgId])
  @@index([periodStart, periodEnd])
  @@map("usage_records")
}

model Invoice {
  id    String @id @default(uuid())
  orgId String @map("org_id")

  stripeInvoiceId String? @map("stripe_invoice_id")

  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  subtotalCents Int @map("subtotal_cents")
  taxCents      Int @default(0) @map("tax_cents")
  totalCents    Int @map("total_cents")

  status String @default("draft")

  pdfUrl String? @map("pdf_url")

  createdAt DateTime  @default(now()) @map("created_at")
  paidAt    DateTime? @map("paid_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("invoices")
}
